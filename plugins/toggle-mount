#!/usr/bin/env sh

# Description: Mount or unmount directories defined in /etc/fstab.
#
# Dependencies: mountpoint, pgrep, pkill, setsid, sudo
#
# Notes: 
#   1. Will handle preview-tui, as generating the dir tree uses the mounted filesystem.
#   2. Uses the selection by default, falls back to current file/directory otherwise.
#
# Shell: POSIX compliant
# Author: beast989898

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/nnn"
SELECTION="${NNN_SEL:-$CONFIG_DIR/.selection}"
PREVIEW_TUI_PATH="$CONFIG_DIR/plugins/preview-tui"

if [ -s "$SELECTION" ]; then
    TARGETS="$(tr '\0' '\n' < "$SELECTION")"
else
    TARGETS="$1"
fi

# Kill preview-tui so the mounted directory is not busy
WAS_RUNNING=0
if [ -x "$PREVIEW_TUI_PATH" ] && pgrep -f "$PREVIEW_TUI_PATH" >/dev/null; then
        WAS_RUNNING=1
        pkill -f "$PREVIEW_TUI_PATH"
fi

printf '%s\n' "$TARGETS" | while IFS= read -r target; do
    [ -z "$target" ] && continue

    [ -d "$target" ] || {
        printf "Not a directory: %s\n" "$target" >&2
        continue
    }

    if mountpoint -q "$target"; then
        if sudo umount "$target"; then
            printf "Unmounted: %s\n" "$target"
        else
            printf "Error: %s is busy!\n" "$target" >&2
        fi
    else
        if sudo mount "$target"; then
            printf "Mounted: %s\n" "$target"
        else
            printf "Failed to mount: %s\n" "$target" >&2
        fi
    fi
done

# Restart preview-tui if process was killed
if [ "${WAS_RUNNING:-0}" -eq 1 ] && [ -x "$PREVIEW_TUI_PATH" ]; then
    setsid "$PREVIEW_TUI_PATH" >/dev/null 2>&1 &
fi

